<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stef Coach: Create running training programs">
    <meta name="theme-color" content="#003087">
    <title>Stef Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #333333, #003087, #D4A017);
            color: #FFFFFF;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .form-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            width: 80%;
            max-width: 600px;
            margin-bottom: 20px;
        }
        label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
        }
        input, select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #FFFFFF;
            padding: 12px;
            margin: 8px 0;
            width: 100%;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
        }
        input:focus, select:focus {
            box-shadow: 0 0 8px rgba(212, 160, 23, 0.5);
            outline: none;
            border-color: #D4A017;
        }
        button {
            background: linear-gradient(135deg, #003087, #D4A017);
            border: none;
            color: #FFFFFF;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            transition: box-shadow 0.3s, transform 0.2s;
        }
        button:hover {
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 80%;
        }
        .week-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            animation: float 4s ease-in-out infinite;
        }
        .week-card h3 {
            margin-top: 0;
            font-size: 1.2rem;
        }
        .week-card p {
            margin: 8px 0;
            font-size: 0.9rem;
        }
        .week-card input[type="text"] {
            width: 60px;
            margin-left: 10px;
            padding: 5px;
            border-radius: 5px;
        }
        .total-km {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            width: 80%;
            max-width: 600px;
            margin-top: 20px;
            text-align: center;
        }
        .total-km h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .print-button {
            margin-top: 20px;
            background: linear-gradient(135deg, #D4A017, #003087);
        }
        footer {
            margin-top: 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }
        #print-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @media (max-width: 768px) {
            .form-container, .results, .total-km {
                width: 100%;
            }
            h1 {
                font-size: 2rem;
            }
        }
        @media print {
            body {
                background: white;
                color: black;
                padding: 0;
                margin: 0;
            }
            .form-container, button, footer, .print-button {
                display: none;
            }
            h1 {
                text-shadow: none;
                color: black;
                text-align: center;
                font-size: 2rem;
            }
            .results {
                display: block;
                width: 100%;
            }
            .week-card {
                background: white;
                border: 1px solid black;
                box-shadow: none;
                animation: none;
                page-break-inside: avoid;
                margin-bottom: 20px;
                padding: 10px;
            }
            .week-card input[type="text"] {
                border: none;
                background: transparent;
                color: black;
                width: auto;
            }
            .total-km {
                background: white;
                border: 1px solid black;
                box-shadow: none;
                text-align: center;
                margin-top: 20px;
            }
            .total-km h3 {
                color: black;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <label>5K Time (mm:ss)</label>
        <input id="5k" placeholder="e.g. 20:00">
        <label>10K Time (mm:ss)</label>
        <input id="10k" placeholder="e.g. 42:00">
        <label>Half Marathon Time (hh:mm:ss)</label>
        <input id="hm" placeholder="e.g. 1:35:00">
        <label>Marathon Time (hh:mm:ss)</label>
        <input id="m" placeholder="e.g. 3:30:00">
        <label>Number of Weeks</label>
        <input id="weeks" type="number" placeholder="e.g. 12">
        <label>Weekly Increase % (e.g. 5 for 5%)</label>
        <input id="weekly_increase" type="number" placeholder="e.g. 5">
        <label>Total km (for base week)</label>
        <input id="total_km" type="number" placeholder="e.g. 60">
        <label>Easy % (e.g. 50 for 50%)</label>
        <input id="easy_percent" type="number" placeholder="e.g. 50">
        <label>Threshold % (e.g. 20 for 20%)</label>
        <input id="thresh_percent" type="number" placeholder="e.g. 20">
        <label>Interval % (e.g. 10 for 10%)</label>
        <input id="inter_percent" type="number" placeholder="e.g. 10">
        <label>Repetition % (e.g. 10 for 10%)</label>
        <input id="rep_percent" type="number" placeholder="e.g. 10">
        <label>Marathon Pace % (e.g. 10 for 10%)</label>
        <input id="marathon_percent" type="number" placeholder="e.g. 10">
        <label>Target Race</label>
        <select id="target_race">
            <option value="">No Target</option>
            <option value="5k">5K</option>
            <option value="10k">10K</option>
            <option value="hm">Half Marathon</option>
            <option value="m">Marathon</option>
        </select>
        <label>Target Time (mm:ss or hh:mm:ss)</label>
        <input id="target_time" placeholder="e.g. 18:00">
        <button onclick="createProgram()">Create Program</button>
    </div>
    <div id="print-content">
        <h1 id="title">Stef Coach</h1>
        <div class="results" id="results"></div>
        <div class="total-km" id="total-km"></div>
        <footer id="footer">Powered with love by Stef</footer>
    </div>
    <button class="print-button" onclick="exportToPDF()" style="display: none;" id="pdfButton">Export to PDF</button>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('Service Worker registered:', reg);
                }).catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
            });
        }

        function parseTime(str) {
            if (!str) return 0;
            let parts = str.split(':');
            let seconds = 0;
            if (parts.length === 2) {
                seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            } else if (parts.length === 3) {
                seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
            }
            return seconds;
        }

        function calculateVDOT(distance, time_seconds) {
            if (time_seconds <= 0) return 0;
            let t = time_seconds / 60;
            let v = distance / t;
            let re = -4.6 + 0.182258 * v + 0.000104 * v * v;
            let percent = 0.8 + 0.1894393 * Math.exp(-0.012778 * t) + 0.2989558 * Math.exp(-0.1932605 * t);
            return re / percent;
        }

        function getPace(vdot, f) {
            let vo2 = vdot * f;
            let a = 0.000104;
            let b = 0.182258;
            let c = -(4.6 + vo2);
            let disc = b * b - 4 * a * c;
            if (disc < 0) return 0;
            let v = (-b + Math.sqrt(disc)) / (2 * a);
            return 1000 / v;
        }

        function formatPace(pace) {
            if (pace === 0) return 'N/A';
            let min = Math.floor(pace);
            let sec = Math.round((pace - min) * 60);
            if (sec < 10) sec = '0' + sec;
            return `${min}:${sec}`;
        }

        function createProgram() {
            const distances = {
                '5k': 5000,
                '10k': 10000,
                'hm': 21097.5,
                'm': 42195
            };
            let vdots = [];
            ['5k', '10k', 'hm', 'm'].forEach(id => {
                let time_str = document.getElementById(id).value;
                let time = parseTime(time_str);
                if (time > 0) {
                    vdots.push(calculateVDOT(distances[id], time));
                }
            });
            let current_vdot = vdots.length > 0 ? Math.max(...vdots) : 0;
            if (current_vdot === 0) {
                alert('Please enter at least one performance.');
                return;
            }
            let weeks = parseInt(document.getElementById('weeks').value);
            if (isNaN(weeks) || weeks <= 0) {
                alert('Enter valid number of weeks.');
                return;
            }
            let weekly_increase = parseFloat(document.getElementById('weekly_increase').value) || 0;
            if (weekly_increase < 0) {
                alert('The weekly increase percentage must be non-negative.');
                return;
            }
            let total_km = parseFloat(document.getElementById('total_km').value) || 0;
            let easy_percent = parseFloat(document.getElementById('easy_percent').value) || 0;
            let thresh_percent = parseFloat(document.getElementById('thresh_percent').value) || 0;
            let inter_percent = parseFloat(document.getElementById('inter_percent').value) || 0;
            let rep_percent = parseFloat(document.getElementById('rep_percent').value) || 0;
            let marathon_percent = parseFloat(document.getElementById('marathon_percent').value) || 0;
            let total_percent = easy_percent + thresh_percent + inter_percent + rep_percent + marathon_percent;
            if (total_km <= 0) {
                alert('Enter valid total km.');
                return;
            }
            if (total_percent !== 100) {
                alert('The sum of percentages must be 100%.');
                return;
            }
            let target_race = document.getElementById('target_race').value;
            let target_time_str = document.getElementById('target_time').value;
            let target_vdot = 0;
            if (target_race && target_time_str) {
                let target_time = parseTime(target_time_str);
                if (target_time > 0) {
                    target_vdot = calculateVDOT(distances[target_race], target_time);
                }
            }
            let easy_km = total_km * (easy_percent / 100);
            let thresh_km = total_km * (thresh_percent / 100);
            let inter_km = total_km * (inter_percent / 100);
            let rep_km = total_km * (rep_percent / 100);
            let marathon_km = total_km * (marathon_percent / 100);
            let f_easy = 0.65;
            let f_thresh = 0.91;
            let f_inter = 1.0;
            let f_rep = 1.08;
            let f_marathon = 0.85;
            let results = document.getElementById('results');
            let totalKmDisplay = document.getElementById('total-km');
            results.innerHTML = '';
            totalKmDisplay.innerHTML = '';
            let totalKmSum = 0;
            let prev_total_km = total_km;
            let increase_factor = 1 + (weekly_increase / 100);
            for (let w = 1; w <= weeks; w++) {
                let vdot_w = current_vdot;
                if (target_vdot > 0) {
                    let progress = (w - 1) / (weeks - 3);
                    progress = Math.min(progress, 1);
                    vdot_w = current_vdot + (target_vdot - current_vdot) * progress;
                }
                let pace_easy = getPace(vdot_w, f_easy);
                let pace_thresh = getPace(vdot_w, f_thresh);
                let pace_inter = getPace(vdot_w, f_inter);
                let pace_rep = getPace(vdot_w, f_rep);
                let pace_marathon = getPace(vdot_w, f_marathon);
                let scale;
                if (w === weeks - 1) {
                    scale = 0.75;
                } else if (w === weeks) {
                    scale = 0.5;
                } else {
                    scale = Math.pow(increase_factor, w - 1);
                }
                let total_w = prev_total_km * scale;
                let easy_w = easy_km * scale;
                let thresh_w = thresh_km * scale;
                let inter_w = inter_km * scale;
                let rep_w = rep_km * scale;
                let marathon_w = marathon_km * scale;
                totalKmSum += total_w;
                let card = document.createElement('div');
                card.className = 'week-card';
                card.id = `week-${w}`;
                card.innerHTML = `
                    <h3>Week ${w} ${w >= weeks - 1 ? '(Tapering)' : ''}</h3>
                    <p>Total km: ${total_w.toFixed(1)}</p>
                    <p>Easy: ${easy_w.toFixed(1)} km at <input type="text" id="easy_pace_${w}" value="${formatPace(pace_easy)}" /> /km</p>
                    <p>Threshold: ${thresh_w.toFixed(1)} km at <input type="text" id="thresh_pace_${w}" value="${formatPace(pace_thresh)}" /> /km</p>
                    <p>Interval: ${inter_w.toFixed(1)} km at <input type="text" id="inter_pace_${w}" value="${formatPace(pace_inter)}" /> /km</p>
                    <p>Repetition: ${rep_w.toFixed(1)} km at <input type="text" id="rep_pace_${w}" value="${formatPace(pace_rep)}" /> /km</p>
                    <p>Marathon Pace: ${marathon_w.toFixed(1)} km at <input type="text" id="marathon_pace_${w}" value="${formatPace(pace_marathon)}" /> /km</p>
                `;
                results.appendChild(card);
                prev_total_km = total_w;
                easy_km = easy_w;
                thresh_km = thresh_w;
                inter_km = inter_w;
                rep_km = rep_w;
                marathon_km = marathon_w;
            }
            totalKmDisplay.innerHTML = `<h3>Total program km: ${totalKmSum.toFixed(1)} km</h3>`;
            document.getElementById('pdfButton').style.display = 'block';
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            const content = document.getElementById('print-content');
            const canvas = await html2canvas(content, {
                scale: 2,
                backgroundColor: null,
                useCORS: true
            });
            const imgData = canvas.toDataURL('image/png');
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
            const scaledWidth = imgWidth * ratio;
            const scaledHeight = imgHeight * ratio;
            let position = 0;
            let heightLeft = scaledHeight;
            doc.addImage(imgData, 'PNG', 0, position, scaledWidth, scaledHeight);
            heightLeft -= pdfHeight;
            while (heightLeft > 0) {
                position = heightLeft - scaledHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, scaledWidth, scaledHeight);
                heightLeft -= pdfHeight;
            }
            doc.save('Stef_Coach_Program.pdf');
        }
    </script>
</body>
</html>
